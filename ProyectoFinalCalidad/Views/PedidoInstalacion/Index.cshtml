@model IEnumerable<ProyectoFinalCalidad.Models.PedidoInstalacion>

@{
    ViewData["Title"] = "Listado de Pedidos de Instalación";
}

<style>
    body {
        background-color: #f0f8ff;
    }

    .container.my-5 {
        max-width: 1000px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(15, 32, 39, 0.1);
        padding: 30px;
        margin: 20px auto;
    }

    h2.title-header {
        font-weight: bold;
        color: #ffffff;
        background: linear-gradient(to right, #0F2027, #203A43, #2C5364);
        padding: 1rem 1.5rem;
        border-radius: 0.75rem 0.75rem 0 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideIn 0.6s ease-out;
    }

    .card-custom {
        border-left: 5px solid #203A43;
        border-radius: 0.75rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .btn-primary {
        background-color: #397DA9;
        border: none;
        font-weight: bold;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

        .btn-primary:hover {
            background-color: #2f6e93;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

    .table thead {
        background: linear-gradient(to right, #0F2027, #203A43, #2C5364);
        color: white;
    }

    .table td, .table th {
        vertical-align: middle;
        font-size: 0.95rem;
        text-align: center;
    }

    .table-hover tbody tr:hover {
        background-color: #eef5fb;
        transition: all 0.2s ease-in-out;
    }

    .badge {
        font-weight: 600;
        font-size: 0.8rem;
        padding: 0.4em 0.7em;
        border-radius: 0.5rem;
        text-transform: capitalize;
    }

    .status-pendiente {
        background-color: #fbc02d;
        color: #212529;
    }

    .status-completado {
        background-color: #2e7d32;
        color: white;
    }

    .status-cancelado {
        background-color: #c62828;
        color: white;
    }

    .btn-outline-info {
        border-color: #00bcd4;
        color: #00bcd4;
    }

    .btn-outline-danger {
        border-color: #ef5350;
        color: #ef5350;
    }

        .btn-outline-info:hover,
        .btn-outline-danger:hover {
            color: white;
            background-color: currentColor;
        }

    .summary-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px dashed #ccc;
    }

    .filter-bar {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px dashed #ced4da;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

        .filter-bar select {
            padding: 0.4rem 0.6rem;
            border-radius: 0.4rem;
            border: 1px solid #ccc;
        }

    .estado-legend {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

        .estado-legend span {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
        }

    .circle-icon {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .icon-pendiente {
        background-color: #fbc02d;
    }

    .icon-completado {
        background-color: #2e7d32;
    }

    .icon-cancelado {
        background-color: #c62828;
    }
</style>


<!-- ?? CONTENIDO -->
<div class="container mt-4">
    <div class="card card-custom">
        <h2 class="title-header">
            <i class="bi bi-list-check"></i> @ViewData["Title"]
        </h2>

        <div class="card-body">
            <div class="summary-bar">
                <a asp-action="Create" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i> Nuevo Pedido
                </a>
                <span>Total: <strong>@Model.Count()</strong> pedidos registrados</span>
            </div>

            <!-- ?? FILTROS Y LEYENDA -->
            <div class="filter-bar">
                <form method="get" asp-action="Index" class="d-flex align-items-center gap-3 flex-wrap">
                    <div>
                        <label class="form-label fw-bold mb-1">Filtrar por estado:</label>
                        <select name="estadoFiltro" class="form-select form-select-sm" onchange="this.form.submit()">
                            @{
                                var estadoSeleccionado = ViewBag.EstadoFiltro as string ?? "Todos";
                                var opciones = new[] { "Todos", "Pendiente", "Completado", "Cancelado" };

                                foreach (var opcion in opciones)
                                {
                                    if (estadoSeleccionado == opcion)
                                    {
                                        <option value="@opcion" selected>@opcion</option>
                                    }
                                    else
                                    {
                                        <option value="@opcion">@opcion</option>
                                    }
                                }
                            }
                        </select>


                    </div>

                    <div class="estado-legend ms-auto">
                        <span><span class="circle-icon icon-pendiente"></span> Pendiente</span>
                        <span><span class="circle-icon icon-completado"></span> Completado</span>
                        <span><span class="circle-icon icon-cancelado"></span> Cancelado</span>
                    </div>
                </form>
            </div>


            <!-- ?? TABLA -->
            @if (!Model.Any())
            {
                <div class="alert alert-warning">No se encontraron pedidos registrados.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Contrato</th>
                                <th>Empleado</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Observaciones</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                var estado = item.EstadoInstalacion?.ToLower();
                                var clase = estado switch
                                {
                                    "completado" => "status-completado",
                                    "pendiente" => "status-pendiente",
                                    "cancelado" => "status-cancelado",
                                    _ => "bg-secondary"
                                };

                                <tr>
                                    <td>@item.PedidoId</td>
                                    <td>
                                        <strong>Contrato #@item.Contrato?.Id</strong><br />
                                        <small class="text-muted">Cliente: @item.Contrato?.Cliente?.Nombres</small>
                                    </td>
                                    <td>@item.Empleado?.nombres</td>
                                    <td>@item.FechaInstalacion?.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <span class="badge @clase text-white text-capitalize">@item.EstadoInstalacion</span>
                                    </td>
                                    <td>@item.Observaciones</td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <a asp-action="Details" asp-route-id="@item.PedidoId" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="Ver detalles">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelarModal-@item.PedidoId" title="Cancelar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>

                                        <!-- Modal -->
                                        <div class="modal fade" id="cancelarModal-@item.PedidoId" tabindex="-1" aria-labelledby="cancelarLabel-@item.PedidoId" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-danger text-white">
                                                        <h5 class="modal-title" id="cancelarLabel-@item.PedidoId">¿Cancelar pedido?</h5>
                                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        ¿Estás seguro que deseas cancelar este pedido de instalación?
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                                                        <form asp-action="Cancelar" asp-route-id="@item.PedidoId" method="post">
                                                            <button type="submit" class="btn btn-danger">Sí, cancelar</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    </script>
}
